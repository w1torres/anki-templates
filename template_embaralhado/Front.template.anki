<div class="question-box" id="definitionBox">{{Definicao}}</div>

<div class="options-box">
  <div id="buttonsContainer" class="buttons-container"></div>
</div>

<br>
<button class="undo-button" style="display: none;">Desfazer</button>

<br>
      <div class="watermark">Â© 2024 AnkiiCards AI. Todos os direitos reservados.</div>

<script>

// FunÃ§Ã£o para gerar os placeholders de letras do termo
function getTermPlaceholders(term) {
  return term.split('').map(() => `<span class="term-placeholder" data-empty="true">ğŸ”²</span>`).join(' ');
}

// FunÃ§Ã£o para embaralhar o termo e criar botÃµes
function generateCard() {
  const definitionText = "{{Definicao}}"; // O texto do cartÃ£o da frente (a ser substituÃ­do no Anki)

  // Usando regex para extrair o conteÃºdo dentro de []
  const regex = /\[([^\]]+)\]/;
  const match = definitionText.match(regex);

  let termText = ""; // O termo a ser embaralhado

  if (match && match[1]) {
    termText = match[1]; // Ex: "Big Data"
  }

  // Armazenar o termo no sessionStorage para ser acessado no verso
  sessionStorage.setItem("termText", termText);

  // Substitui o termo na definiÃ§Ã£o por placeholders (ğŸ”²)
  const displayDefinition = definitionText.replace(regex, getTermPlaceholders(termText));
  document.querySelector(".question-box").innerHTML = displayDefinition; // Exibe a definiÃ§Ã£o com os placeholders

  const buttonsContainer = document.getElementById("buttonsContainer");

  // Embaralha o termo e cria os botÃµes
  const shuffledOptions = [...termText].sort(() => Math.random() - 0.5);

  shuffledOptions.forEach((char, index) => {
    const button = document.createElement("button");
    button.textContent = char;
    button.className = "option-button";
    button.dataset.char = char;

    // Ao clicar, preenche a posiÃ§Ã£o do placeholder
    button.addEventListener("click", () => {
      // Encontra o prÃ³ximo placeholder vazio
      const emptySlot = document.querySelector(".term-placeholder[data-empty='true']");
      if (emptySlot) {
        console.log(`Preenchendo o placeholder com a letra: ${char}`); // Verifica a letra sendo preenchida
        emptySlot.textContent = char; // Preenche a letra
        emptySlot.style.color = "blue"; // A cor da letra fica azul
        emptySlot.dataset.empty = "false"; // Marca o placeholder como preenchido
        button.disabled = true; // Desabilita o botÃ£o apÃ³s o clique
        button.style.display = "none"; // Esconde o botÃ£o apÃ³s o clique
      }

      // Verifica se todos os espaÃ§os estÃ£o preenchidos
      checkAnswer(termText);
    });

    buttonsContainer.appendChild(button);
  });

}

// FunÃ§Ã£o para verificar se o termo foi preenchido corretamente
function checkAnswer(correctAnswer) {
  const termPlaceholders = document.querySelectorAll(".term-placeholder");
  const userInput = [...termPlaceholders].map(placeholder => placeholder.textContent).join('');
  
  // Verifica o estado dos placeholders
  console.log("Estado dos placeholders:", [...termPlaceholders].map(placeholder => placeholder.textContent).join(''));

  // Quando todos os placeholders sÃ£o preenchidos
  if ([...termPlaceholders].every(placeholder => placeholder.textContent !== 'ğŸ”²')) {
    const feedback = document.createElement("div");
    feedback.className = "feedback-box";

    if (userInput === correctAnswer) {
      feedback.textContent = "Correto! ğŸ‰";
      feedback.style.color = "green";
    } else {
      feedback.textContent = `Incorreto! O termo correto Ã©: "${correctAnswer}"`;
      feedback.style.color = "red";
    }

    document.body.appendChild(feedback);

    setTimeout(() => {
      resetCard(feedback);
    }, 3000);
  }
}

// FunÃ§Ã£o para desfazer a Ãºltima letra preenchida
function undoLastLetter() {
  // Encontra o Ãºltimo placeholder preenchido
  const filledPlaceholders = document.querySelectorAll(".term-placeholder:not([data-empty='true'])");
  console.log(filledPlaceholders); // Verifique se a lista de placeholders preenchidos estÃ¡ correta
  // Se houver placeholders preenchidos
  if (filledPlaceholders.length > 0) {
    const lastFilled = filledPlaceholders[filledPlaceholders.length - 1];
    const charToUndo = lastFilled.textContent; // Captura o caractere preenchido antes de apagÃ¡-lo

    lastFilled.textContent = 'ğŸ”²'; // Substitui o preenchimento por um placeholder vazio
    lastFilled.dataset.empty = 'true'; // Marca o placeholder como vazio novamente

    // Encontre o botÃ£o correspondente e reabilite-o
    const lastButton = document.querySelector(`.option-button[data-char="${charToUndo}"]`);
    console.log("BotÃ£o: ", lastButton)
    if (lastButton) {
      lastButton.disabled = false; // Reabilita o botÃ£o
      lastButton.style.display = "inline-block"; // Torna o botÃ£o visÃ­vel novamente
    }
  }

  // Verifica se hÃ¡ mais placeholders preenchidos
  const undoButton = document.querySelector(".undo-button");
  const remainingFilledPlaceholders = document.querySelectorAll(".term-placeholder:not([data-empty='true'])");

  // Se nÃ£o houver mais preenchimentos, esconde o botÃ£o "Desfazer"
  if (remainingFilledPlaceholders.length === 1) {
    undoButton.style.display = "true"; // Esconde o botÃ£o "Desfazer"
  }
}

// FunÃ§Ã£o para exibir o botÃ£o "Desfazer"
function showUndoButton() {
  const undoButton = document.querySelector('.undo-button'); // Seleciona o botÃ£o "Desfazer"
  
  // Verifica se o botÃ£o existe
  if (undoButton) {
    // Exibe o botÃ£o "Desfazer"
    undoButton.style.display = 'inline-block';
    undoButton.addEventListener('click', undoLastLetter); // Adiciona o evento de clique
  } else {
    console.warn('BotÃ£o "Desfazer" nÃ£o encontrado!');
  }
}

/* // FunÃ§Ã£o para resetar o cartÃ£o apÃ³s a verificaÃ§Ã£o
function resetCard(feedback) {
  const termPlaceholders = document.querySelectorAll(".term-placeholder");
  const optionButtons = document.querySelectorAll(".option-button");

  termPlaceholders.forEach(placeholder => placeholder.textContent = 'ğŸ”²'); // Reseta os placeholders
  termPlaceholders.forEach(placeholder => placeholder.style.color = "black"); // Reseta a cor da letra
  termPlaceholders.forEach(placeholder => placeholder.dataset.empty = "true"); // Marca os placeholders como vazios
  optionButtons.forEach(button => {
    button.disabled = false; // Reabilita os botÃµes
    button.style.display = "inline-block"; // Exibe os botÃµes novamente
  });

  feedback.remove();
} */

// Inicializa o cartÃ£o
generateCard();
showUndoButton();
</script>

